# 《关于错排公式》`2024-09-15`

- 这个证明是我自己写着玩的，并没有参考别人的证明，因此可能会有细节上的谬误，欢迎各位读者指正。

## 1. 错排公式的递推形式

- 设 $N$ 个互不相同的物品，$N\geq 1$，$N$ 个物品编号为 $1, 2, \cdots, N$，将这些物品排成一列。试问有多少种方案，使得任意物品所在的位置的编号与自己的物品编号均不相同。
- 设 $F(k)$ 为 $N=k$ 时的错排方案数。
  - 则 $F(1)=0, F(2)=1, F(3)=2$
- 考虑 $N\geq 4$，我们现在考虑编号为 $1$ 的物品将被放在哪里，设编号为 $1$ 的物品被放置在位置 $x$。
  - 现在我们考虑所有方案中，$x$ 要么被放在了位置 $1$，要么被放在了除了位置 $1$ 之外的某个位置上。
  - 假设 $x$ 被放在了位置 $1$，
    - 则剩余的 $N-2$ 个物品构成了一新的子错排问题，方案数为 $F(N-2)$
  - 假设 $x$ 不放在位置 $1$，
    - 现在我们考虑数值集合 $2, 3, \cdots, N$ 以及位置集合 $1, 2, \cdots, x-1, x+1, \cdots, N$
    - 其中 $2$ 号物品可以放置在编号为 $1, 3, \cdots, N$ 的位置，总共有 $N-2$ 个可用位置。
      - 其中 3 号物品也同理，有 $N-2$ 各可用位置。
    - 类似地我们可以说明除了 $x$ 外，所有物品都恰不能放在自己对应的位置上。
    - 最后再看物品 $x$，由于 $1$ 占据了 $x$ 原先的位置，因此 $x$ 看起来有 $N-1$ 各可用位置。
      - 但是由于实际上我们假设了 $x$ 不放在位置 $1$，因此 $x$ 也有 $N-2$ 各可用位置。
      - 现在我们把位置 $1$ 的标签撕下来，贴上位置 $x$ 的标签，问题变成了一个同构的错排子问题。
      - 我们能够证明，每存在一种 “$x$ 不放在位置 $1$” 的错排方案，我们就能一一对应的找到一种 $N-1$ 个元素的错排方案。
    - 根据这种一一对应关系，我们可以证明 $x$ 不放在位置 $1$ 的错排方案为 $F(N-1)$
- 最终 $F(N)=(N-1)(F(N-1)+F(N-2))$

## 2. 错排公式的极限情况

- 设 $N$ 足够大，随机生成一个 $1, 2, \cdots, N$ 的错排，以古典概型分析，生成出的排列恰是错排的概率。
  - 答案即为 $\lim_{n\to\infty}\frac{F(n)}{n!}$
- 后面的变形我只能说真的是妙手偶得了，我也不知道怎么想到的。
  - 设 $G(n)=\frac{F(n)}{n!}$ 对递推公式两侧同时除以 $n!$。
    - 得到 $G(n)=(1-\frac 1 n)G(n-1)+\frac 1 n G(n-2)$
    - 变形：$G(n)-G(n-1)=-\frac 1 n (G(n-1)-G(n-2))$
  - 妙不可言，设 $H(n)=G(n-1)-G(n-2)$
    - 所以有 $H(2)=\frac 1 2, H(3)=-\frac 1 6$
    - $H(n)=-\frac 1 n H(n-1)$
  - 这里可以得到 $H(n)=\frac {(-1)^n}{n!}=G(n)-G(n-1)$
    - 根据初始条件 $G(1)=0$ 得到
    - $G(n)=H(n)+H(n-1)+\cdots+H(2)+G(1)=H(n)+H(n-1)+\cdots+H(2)=\sum_{k=2}^n \frac{(-1)^n}{n!}$
- 回顾 $e^x=\sum_{n=0}^\infty \frac{x^n}{n!}$
  - 于是 $e^{-1}=1+(-1)+\sum_{n=2}^\infty \frac{(-1)^n}{n!}=\lim_{n\to\infty}G(n)$
- 最终得到错排发生概率趋近于 $\frac 1 e$
  - 诶，我怎么记得上次课上老师说这东西是 $1-\frac 1 e$ 呢？我下次课去问问他。
  - 这里有一个使用 $G(n)$ 进行验证的 `python` 程序 [2024-09-15_derange.py](./2024-09-15_derange.py)

